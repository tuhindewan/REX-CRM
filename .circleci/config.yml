version: 2.1
description: Generate reports from phpunit-test wordpress

commands:
  init_env:
    steps:
      - run:
          name: Install git
          command: |
            apt-get update
            apt install -y git
      - checkout
      - run:
          name: Configuration
          command: |
            apt-get update -yqq
            apt install git libpq-dev libzip-dev zip -yqq
            apt-get -yqqf install vim wget zip unzip subversion default-mysql-client libmcrypt-dev default-libmysqlclient-dev --fix-missing
            docker-php-ext-install mysqli pdo_mysql
            curl -sS https://getcomposer.org/installer | php
            php composer.phar install
            bash bin/install-wp-tests.sh wordpress wordpress wordpress "127.0.0.1" latest true
  run_phpunit:
    steps:
      - run:
          name: Run WP Phpunit
          command: composer run test

executors:
  php_mysql_executor:
    docker:
      - image: cimg/php:7.4.26
      - image: mysql:5.7.27
        environment:
          MYSQL_ROOT_PASSWORD: somewordpress
          MYSQL_DATABASE: wordpress
          MYSQL_USER: wordpress
          MYSQL_PASSWORD: wordpress

jobs:
  phpunit_test_reports_with_s3:
    executor: php_mysql_executor
    steps:
      - init_env
      - run_phpunit


# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      - phpunit_test_reports_with_s3